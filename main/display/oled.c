//
// Created by rmukhia on 18/6/22.
//

#include <esp_err.h>
#include <esp_log.h>
#include "oled.h"
#include "driver/gpio.h"
#include "u8g2_esp32_hal.h"

static const char *TAG = "IO_OLED";

#define OLED_SDA    GPIO_NUM_21
#define OLED_SCL    GPIO_NUM_22
#define OLED_I2C

#define SCREEN_ADDRESS  0x3C ///< See datasheet for Address; 0x3D for 128x64, 0x3C for 128xt32
#define SCREEN_WIDTH    128
#define SCREEN_HEIGHT   64

static struct {
    gpio_num_t sda;
    gpio_num_t scl;
    uint8_t i2c_address;
    u8g2_esp32_hal_t u8g2_esp32_hal;
    u8g2_t driver;
} __oled = {
    .sda = OLED_SDA,
    .scl = OLED_SCL,
    .i2c_address = SCREEN_ADDRESS,
    .u8g2_esp32_hal = U8G2_ESP32_HAL_DEFAULT,
};


const uint8_t bitmap_logo [] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x56, 0x66, 0x65,
    0x56, 0x66, 0x65, 0x56, 0x66, 0x65, 0x56, 0x66, 0x65, 0xFA, 0x1F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x1C, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x80, 0x01, 0x00, 0x00, 0x18, 0x00,
    0x00, 0x70, 0x00, 0xE3, 0x00, 0x80, 0x01, 0x00, 0x00, 0x01, 0x07, 0x06,
    0x00, 0x00, 0x18, 0x00, 0x00, 0x60, 0x00, 0xC3, 0x00, 0x80, 0x01, 0x00,
    0xC0, 0xF0, 0x7A, 0x0C, 0x00, 0x00, 0x18, 0x00, 0x00, 0x70, 0x00, 0x03,
    0x00, 0x80, 0x01, 0x0C, 0x40, 0x1C, 0xC0, 0x08, 0x00, 0x00, 0x18, 0x00,
    0x00, 0x70, 0x00, 0x03, 0x00, 0x80, 0x01, 0x0C, 0x60, 0x04, 0x80, 0x11,
    0x30, 0x00, 0x18, 0x00, 0x00, 0x60, 0x00, 0x03, 0x00, 0x80, 0x01, 0x1C,
    0x20, 0x03, 0x00, 0x33, 0x60, 0xC0, 0x1F, 0x3E, 0xF0, 0xF1, 0x07, 0xC3,
    0xF0, 0x87, 0x3F, 0x7E, 0x90, 0x01, 0x00, 0x22, 0x40, 0xE0, 0x1F, 0x7E,
    0xF8, 0xF1, 0x0F, 0xC3, 0xF8, 0x8F, 0x3F, 0x7E, 0x90, 0x00, 0x00, 0x44,
    0x80, 0x60, 0x18, 0x60, 0x18, 0x60, 0x0C, 0xC3, 0x18, 0x8E, 0x71, 0x1C,
    0x88, 0x78, 0x66, 0x4C, 0x80, 0x60, 0x18, 0xE0, 0x18, 0x70, 0x1C, 0xC3,
    0x18, 0x86, 0x61, 0x0C, 0xC8, 0x48, 0x66, 0x48, 0x00, 0x61, 0x18, 0xFC,
    0x18, 0x60, 0x1C, 0xC3, 0x1C, 0x8E, 0x61, 0x1C, 0x48, 0x48, 0x66, 0x48,
    0x00, 0x63, 0x18, 0xFF, 0xF8, 0x30, 0x18, 0xC3, 0x18, 0x86, 0x61, 0x0C,
    0x48, 0x78, 0x5A, 0xC8, 0x00, 0x62, 0x18, 0xC3, 0xF0, 0x61, 0x1C, 0xC3,
    0xF8, 0x87, 0x61, 0x1C, 0x48, 0x68, 0x5A, 0x48, 0x00, 0x63, 0x18, 0xE3,
    0x80, 0x73, 0x08, 0xC3, 0xF0, 0x83, 0x61, 0x08, 0x48, 0x48, 0x5A, 0x48,
    0x00, 0x61, 0x18, 0xE3, 0x80, 0x73, 0x1C, 0xC3, 0x30, 0x80, 0x61, 0x1C,
    0x48, 0x48, 0x42, 0x48, 0x80, 0x61, 0x1C, 0x63, 0x80, 0x61, 0x18, 0xE3,
    0xF0, 0x83, 0x61, 0x1C, 0xC8, 0x00, 0x00, 0x4C, 0x80, 0xE0, 0x1F, 0xFF,
    0xF8, 0x21, 0x08, 0xC7, 0xF0, 0x87, 0x71, 0x78, 0x90, 0x00, 0x00, 0x64,
    0x40, 0xC0, 0x1F, 0xFE, 0xF9, 0x70, 0x1C, 0xC7, 0x00, 0x8E, 0x61, 0x78,
    0x10, 0x01, 0x00, 0x26, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x0C, 0x00, 0x00, 0x30, 0x02, 0x00, 0x23, 0x30, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x20, 0x06, 0x80, 0x11,
    0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x0F, 0x00, 0x00,
    0x40, 0x1C, 0xC0, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF8, 0x03, 0x00, 0x00, 0xC0, 0x70, 0x3C, 0x0C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0x07, 0x02,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x06, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0xF0, 0x00, 0x98, 0xD6, 0x69, 0x9D,
    0xD6, 0x69, 0x9D, 0xD6, 0xAA, 0xAA, 0xAA, 0xAA, 0x9D, 0xFA, 0x1F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, };

static void screen_text_draw(u8g2_t *driver)
{
    ESP_LOGE(TAG, "About Menu");
    u8g2_ClearBuffer(driver);
    u8g2_SetPowerSave(driver, 0); // wake up display

    u8g2_DrawBox(driver, 0, 26, 80,6);
    u8g2_DrawFrame(driver, 0,26,100,6);
    u8g2_SetFont(driver, u8g2_font_ncenB14_tr);
    u8g2_DrawStr(driver, 2,17, "Hello world!");

    u8g2_SendBuffer(driver);
}

static void screen_bitmap_draw(u8g2_t *driver)
{
    ESP_LOGD(TAG, "Load Screen");
    u8g2_ClearBuffer(driver);
    u8g2_SetPowerSave(driver, 0); // wake up display

    u8g2_DrawXBM(driver, 0, 0, 128, 64, bitmap_logo);
    u8g2_SendBuffer(driver);
}

esp_err_t io_oled_init()
{
    __oled.u8g2_esp32_hal.sda = __oled.sda;
    __oled.u8g2_esp32_hal.scl = __oled.scl;

    u8g2_esp32_hal_init(__oled.u8g2_esp32_hal);

    u8g2_Setup_ssd1306_i2c_128x64_noname_f(
        &__oled.driver,
        U8G2_R0,		//u8x8_byte_sw_i2c,
        u8g2_esp32_i2c_byte_cb,
        u8g2_esp32_gpio_and_delay_cb);  // init u8g2 structure

    u8x8_SetI2CAddress(&__oled.driver.u8x8, __oled.i2c_address << 1);

    ESP_LOGI(TAG, "u8g2_InitDisplay");
    // send init sequence to the display, display is in sleep mode after this,
    u8g2_InitDisplay(&__oled.driver);

    ESP_LOGI(TAG, "Initialized OLED driver %p",  &__oled.driver);


    screen_bitmap_draw(&__oled.driver);

    return ESP_OK;
}